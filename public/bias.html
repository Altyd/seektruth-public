<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeekTruth</title>
    <meta name="description" content="Stay informed with confidence. SeekTruth analyzes articles for political bias, delivering accurate and balanced information." />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #1c1c1e;
            color: #f5f5f7;
        }
        .container {
            top: auto;
            transform: translateY(25%); 
            width: 100%;
            max-width: 600px;
            padding: 20px;
            text-align: center;
            position: relative;
            
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        h1 {
            font-size: 2rem;
            color: #2a9d8f;
        }
        .step-counter {
            font-size: 1.5rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #2a9d8f;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .source-label {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        input[type="text"], textarea {
            width: 350px;
            padding: 15px;
            border-radius: 25px;
            border: 1px solid #2a9d8f;
            background-color: #1c1c1e;
            color: #f5f5f7;
            margin-bottom: 15px;
            font-size: 1rem;
            text-align: center;
        }
        .manual-entry {
            font-size: 1rem;
            text-decoration: underline;
            cursor: pointer;
            color: #2a9d8f;
        }
        button {
            width: 100%;
            padding: 15px;
            border-radius: 25px;
            background-color: #2a9d8f;
            color: white;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #264653;
        }
        .hidden {
            display: none;
        }
        .result {
            visibility: hidden;
            text-align: center;
            padding: 55px;
        }
        .circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 10px solid #2a9d8f;
            position: relative;
            margin: 0 auto;
        }
        .circle.complete {
            border-top-color: transparent;
        }
        .percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: #fff;
        }
        .info-tooltip {
    display: inline-block;
    margin: 10px 0;
    font-size: 0.9rem;
    color: #ffffff; /* White text for better visibility */
}

#community-rating-container {
        display: none;
        margin-top: 10px;
        font-family: Arial, sans-serif;
    }

    /* Range slider styling */
    #community-rating {
        width: 100%;
        appearance: none;
        background: #ddd;
        height: 6px;
        border-radius: 3px;
        outline: none;
        transition: background 0.3s ease;
    }
    
    #community-rating::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        background-color: #007bff;
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    #community-rating::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background-color: #007bff;
        border-radius: 50%;
        cursor: pointer;
    }

    /* Make tooltip visible */
    #community-rating-container.show-tooltip .tooltip {
        opacity: 1;
    }
#submit-rating {
    margin-top: 15px;
    background-color: #2a9d8f; /* Green button for rating submission */
    color: white;
}

#submit-rating:hover {
    background-color: #264653; /* Darker green on hover */
}
        .share-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        .share-button {
            margin: 0 10px;
        }
        .share-button img {
            width: 30px;
            height: 30px;
            cursor: pointer;
        }
        .modal {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(0, 0, 0, 0.5);
         justify-content: center;
         align-items: center;
        }
        .modal-content {
            background-color: #121212;
            color: #000;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .modal.active {
        display: flex;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-out {
            animation: fadeOut 0.5s forwards;
        }
        .fade-in {
            animation: fadeIn 0.5s forwards;
        }
        .logout-btn {
            margin-top: 20px;
            width: auto;
            padding: 10px 20px;
        }

#image-display {
    max-width: 100%; /* Keep the image responsive */
    border-radius: 15px; /* Rounded corners */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for depth */
    margin-top: 15px;
    transition: transform 0.3s; /* Smooth scale effect */
}

#image-display:hover {
    transform: scale(1.05); /* Slightly enlarge on hover */
}
#image-upload {
    display: none; /* Hide the default file input */
}

/* Style for the custom upload button */
.custom-upload {
    width: 80%; /* Change width to 80% for a smaller button */
    padding: 10px; /* Reduce padding for a smaller button */
    border-radius: 25px;
    background-color: #2a9d8f;
    color: white;
    font-size: 0.9rem; /* Slightly smaller font size */
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: none; /* Initially hidden */
    margin-top: 10px; /* Add margin above the button */
    margin: 10px auto;
}

.custom-upload:hover {
    background-color: #264653;
}

/* Style for image preview */
#image-preview {
    margin-top: 15px;
}
#community-rating-container {
        display: none;
    }


    .modal2 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-content2 {
            background-color: #272727;
            padding: 30px;
            border-radius: 12px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            text-align: center;
            position: relative;
        }

        .modal.show2 {
            visibility: visible;
            opacity: 1;
        }

        .modal-content2 h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #ffffff;
        }

        .modal-content2 p {
            font-size: 16px;
            color: #d1d1d1;
            margin-bottom: 25px;
        }

        .modal-content2 .price-info {
            font-size: 18px;
            font-weight: 600;
            color: #f0c674;
        }

        .modal-content2 button {
            background-color: #227e73;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .modal-content2 button:hover {
            background-color: #1d6a61;
        }

        .close-modal2 {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 20px;
            color: #fff;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal2:hover {
            color: #f0c674;
        }

        /* Animation for modal */
        @keyframes modalEntry2 {
            0% {
                transform: translateY(-50px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal.show2 .modal-content {
            animation: modalEntry 0.5s ease forwards;
        }
        a {
    color: #a6a6a8; /* This is the green color used in your scheme */
    text-decoration: underline; /* Optional: Makes the link stand out */
}

a:hover {
    color: #264653; /* Darker green on hover */
}
        #no-analysis-message {
    background-color: #800000; /* A suitable green color */
    color: #f5f5f7; /* Light text color for contrast */
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    top: 20px; /* Adjust based on your layout */
    left: 50%;
    transform: translateY(32%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    z-index: 10; /* Ensure it appears above other content */
}


.lds-facebook2,
.lds-facebook2 div {
  box-sizing: border-box;
}
.lds-facebook2 {
    top: 50%;
    left: 50%;
    transform: translate(-293%, -25%);
  display: inline-block;
  position: relative;
  width: 80px;
  height: 80px;
}
.lds-facebook2 div {
  display: inline-block;
  position: absolute;
  left: 8px;
  width: 16px;
  background: currentColor;
  animation: lds-facebook 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
}
.lds-facebook2 div:nth-child(1) {
  left: 8px;
  animation-delay: -0.24s;
}
.lds-facebook2 div:nth-child(2) {
  left: 32px;
  animation-delay: -0.12s;
}
.lds-facebook2 div:nth-child(3) {
  left: 56px;
  animation-delay: 0s;
}
@keyframes lds-facebook2 {
  0% {
    top: 8px;
    height: 64px;
  }
  50%, 100% {
    top: 24px;
    height: 32px;
  }
}

.lds-facebook,
.lds-facebook div {
  box-sizing: border-box;
}
.lds-facebook {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -40%);
  display: inline-block;
  position: relative;
  width: 80px;
  height: 80px;
}
.lds-facebook div {
  display: inline-block;
  position: absolute;
  left: 8px;
  width: 16px;
  background: currentColor;
  animation: lds-facebook 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
}
.lds-facebook div:nth-child(1) {
  left: 8px;
  animation-delay: -0.24s;
}
.lds-facebook div:nth-child(2) {
  left: 32px;
  animation-delay: -0.12s;
}
.lds-facebook div:nth-child(3) {
  left: 56px;
  animation-delay: 0s;
}
@keyframes lds-facebook {
  0% {
    top: 8px;
    height: 64px;
  }
  50%, 100% {
    top: 24px;
    height: 32px;
  }
}


    </style>
</head>
<div>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@10"></script>
    <div class="container2">
        <div class="login-screen active" id="loginScreen">
            <h1>Welcome to SeekTruth</h1>
            <div class="lds-facebook" id="loginLoader" >
                <div></div><div></div><div></div>
            </div>
            
            <!-- Google login button -->
            <button id="loginButton" style="display: none;" onclick="initiateLogin()">Login with Google</button>
        </div>
        

        <div id="keyPopup" class="modal">
            <div class="modal-content">
                <h1>Paid User Register</h1>
                <div class="modal-content2">
                    <span class="close-modal2" id="closeModal2">&times;</span>
                    <h2>Unlock Premium Access!</h2>
                    <p>Start your <strong>30-day free trial</strong> of the Basic Plan and gain access to exclusive features.</p>
                    <p class="price-info">After 30 days, it's only R30/month.</p>
                    <a href="https://seektruth.co.za/profile" target="_blank">
                        <button
                          type="button"
                          id="startFreeTrialButton"
                        >
                          Start Free Trial
                        </button>
                    </a>
                    
    <a href="https://seektruth.co.za" target="_blank">
        <p class="manual-entry">Support SeekTruth By Becoming A Paid Member</p>
      </a>
    <p class="manual-entry"onclick="continue_free()">Continue For Free</p>
    
                </div>
            </div>
        </div>
        <div id="freeTrialModal" class="modal2">
            <div class="modal-content2">
                <span class="close-modal2" id="closeModal2">&times;</span>
                <h2>Unlock Premium Access!</h2>
                <p>Start your <strong>30-day free trial</strong> of the Basic Plan and gain access to exclusive features.</p>
                <p class="price-info">After 30 days, it's only R30/month.</p>
                <button
  data-sellix-product="67114916a55e5"
  data-sellix-custom-id="startFreeTrialButton"
  type="submit"
>
Start Free Trial
</button>

            </div>
        </div>

        <div class="profile-screen hidden" id="profileScreen">
            <h1>Welcome, <span id="username"></span>!</h1>
            <button class="logout-btn" id="logoutButton">Logout</button>
        </div>
    </div>
<div class="container" id="contentContainer">
    <header>
        <h1>SeekTruth Bias Detection</h1>
        <div class="step-counter" id="step-counter">1/4</div>
    </header>

    <div id="step-1">
        <p class="source-label">Source</p>
        <input id="url" type="text" placeholder="Paste URL here..." />
        <p class="manual-entry" onclick="toggleManualEntry()">Enter Manually</p>
        <textarea id="manual-article" class="hidden" placeholder="Paste your article here..."></textarea>
        
        <p class="manual-entry" onclick="toggleImageEntry()">Upload an Image</p>
        <button class="custom-upload" id="upload-button" onclick="document.getElementById('image-upload').click();">Choose File</button>
        <input type="file" id="image-upload" accept="image/*" onchange="handleImageUpload(event)" />
        <div class="lds-facebook2" id="loginLoader2" >
            <div></div><div></div><div></div>
        </div>
        
        <div id="image-preview">
            <img id="image-display"  onchange="handleImageUpload(event) "src="" />
        </div>
        <button id="continuebtn" onclick="nextStep()">Continue</button>
    </div>
    

    <div id="step-2" class="hidden">
        <div class="h-captcha" data-sitekey="d93e60b6-16d4-492c-840c-afda1c3aad1e" data-callback="hcaptchaCallback" data-theme="dark"></div>
        <button onclick="validateCaptcha()">Continue</button>
    </div>

    <div id="step-3" class="hidden">
        <button id="analyzebtn" onclick="startAnalysis()">Analyze</button>
        <div id="no-analysis-message" class="hidden">
            <p>No Analysis Points Left Today, <a href="https://www.seektruth.co.za" id="upgrade-link">Consider Upgrading Your Plan</a></p>
        </div>
    </div>

    <div id="result" class="result">
        <div class="circle" id="circle">
            <div class="percentage" id="percentage"></div>
        </div>
        <p id="bias-label">Bias Rating</p>
        <p id="bias-com">Community Rating</p>
        <p id="political-leaning">No Leaning</p>
        <p id="bias-reasoning">Reasoning</p>
        <div id="community-rating-container">
            <label for="community-rating">Rate the bias (0-100%):</label>
            <div id="tooltip" class="tooltip">50%</div>
            <div style="position: relative; width: 100%;">
                <input type="range" id="community-rating" min="0" max="100" value="50" oninput="updateTooltip(this.value)">
            </div>
            <button onclick="submitCommunityRating()">Submit Rating</button>
        </div>
        <canvas id="qr-code"></canvas>
        <p>SeekTruth.co.za</p>
        <a id="article-url"></a>

        <div class="share-buttons">
            <div class="share-button" onclick="shareToTwitter()">
                <img src="https://img.freepik.com/premium-vector/twitter-new-logo-twitter-icons-new-twitter-logo-x-2023_929078-218.jpg" alt="Twitter">
            </div>
            <div class="share-button" onclick="downloadImage()">
                <img src="https://i.postimg.cc/zbcpvbFN/picture.png" alt="Download">
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://hcaptcha.com/1/api.js" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@latest/dist/qrious.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7133988848219073"
     crossorigin="anonymous"></script>
<script>
    let he = "";
            const client = new Appwrite.Client()
            .setEndpoint('https://auth.seektruth.co.za/v1')  
            .setProject('66fbaec80033432c3451');

        const account = new Appwrite.Account(client);

        const loginScreen = document.getElementById('loginScreen');
        const profileScreen = document.getElementById('profileScreen');
        const contentContainer = document.getElementById('contentContainer');
        const noidea = document.getElementById('container2');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const usernameSpan = document.getElementById('username');
        const submitKeyButton = document.getElementById('submitKeyButton');
        const continuebtn = document.getElementById('continuebtn');
        const analyzebtn = document.getElementById('analyzebtn');
        const keyPopup = document.getElementById('keyPopup');
        document.getElementById('loginLoader2').style.display = 'none';
        //submitKeyButton.addEventListener('click', submitKey);
        // Function to check login status
        function initiateLogin() {
    // Hide the login button and show the loader
    document.getElementById('loginButton').style.display = 'none';
    document.getElementById('loginLoader').style.display = 'inline-block';
    
    // Call the checkLoginStatus function to handle login
    checkLoginStatus();
}
async function checkLoginStatus() {
    contentContainer.classList.add('hidden');
    
    try {
        const user = await account.get();
        console.log('Logged in user email:', user.email);
        const isValid = await validateSubscription(user.email);

        if (isValid.valid) {
            if (isValid.subscriptionType === 'free') {
                console.log('Free subscription detected. Showing login form.');
                keyPopup.classList.add('active'); // Show the login form for free users
            } else {
                console.log('Paid subscription is valid.');
                showContent(); // Show the main content for paid users
            }
        } else {
            //keyPopup.classList.add('active'); // Show the key entry modal for invalid or expired subscriptions
            console.log('No valid subscription found, prompting for key.');
        }
    } catch (error) {
        console.error('User not logged in:', error);
        showLoginScreen();
    } finally {
        // Hide the loader and display the login button in case of error
        document.getElementById('loginLoader').style.display = 'none';
        document.getElementById('loginButton').style.display = 'inline-block';
    }
}
        // Function to hash the email using SHA-256
        async function hashEmail(email) {
            const encoder = new TextEncoder();
            const data = encoder.encode(email);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashedEmail = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
            he = hashedEmail;
            console.log('Hashed email:', hashedEmail);
            return hashedEmail;
        }
        async function submitKey() {
    const userKey = document.getElementById('userKey').value;
    console.log('Entered key:', userKey);

    // Send the key submission to the back-end
    const response = await fetch('https://www.seektruth.co.za/api/submit-key', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            key: userKey,
            emailHash: he
        })
    });

    if (response.ok) {
        const result = await response.json();
        alert(result.message);
        window.location.reload();  // Reload the page to refresh the state
    } else {
        const error = await response.json();
        alert('Error: ' + error.message);
    }
}

async function validateSubscription(email) {
    try {
        const hashedEmail = await hashEmail(email.toLowerCase()); // Hash the email after converting to lowercase

        // Fetch the subscription status from your API
        const response = await fetch('https://www.seektruth.co.za/api/get-subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                emailHash: hashedEmail,
            }),
        });

        if (!response.ok) {
            console.error('Failed to validate subscription.');
            return { valid: false }; // Return invalid status if there's an error
        }

        const data = await response.json(); // Parse the response correctly

        if (data.valid) {
            console.log(`Subscription is valid. Type: ${data.subscriptionType}`);
            return { valid: true, subscriptionType: data.subscriptionType }; // Return type with validity
        } else {
            console.log('Subscription is invalid or has expired.');
            return { valid: false }; // Invalid or expired subscription
        }
    } catch (error) {
        console.error('Error during subscription validation:', error);
        return { valid: false }; // Return invalid status in case of an exception
    }
}

        // Function to show login screen
        function showLoginScreen() {
            loginScreen.classList.add('active');
            profileScreen.classList.remove('active');
            contentContainer.classList.add('hidden');
        }

        // Function to show profile screen
        function showProfileScreen(username) {

}
async function continue_free() {
    if (!he) {
        alert('Please enter your email to continue with the free plan.');
        return;
    }
    console.log("CURRENT HASH:", he);

    try {
        // Send request to the backend to activate the free plan
        const response = await fetch('/api/free-subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                emailHash: he
            }) // Send the hashed email to the backend
        });

        const data = await response.json();

        if (response.ok) {
            // Show success message
            alert('Free plan activated successfully! You can now start using the service.');
            keyPopup.classList.remove('active');  // Hide the key popup/modal
            showContent();  // Show the content that was hidden before the user activated the plan
            console.log('Using Free Version');
            showModal2();
        } else {
            // Show error message
            alert(data.message || 'Failed to activate the free plan. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('There was an error processing your request. Please try again.');
    }
}

        // Function to show main content
        function showContent() {
            contentContainer.classList.remove('hidden');
            profileScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
        }

        // Event listener for login button
        loginButton.addEventListener('click', function () {
            account.createOAuth2Session('google', 'https://www.seektruth.co.za/bias');
        });

        // Event listener for logout button
        logoutButton.addEventListener('click', async function () {
            await account.deleteSession('current');
            showLoginScreen();
        });

        // On page load, check if user is logged in
        checkLoginStatus(); 

        //images
    // Toggle image entry for upload
    function toggleImageEntry() {
        const uploadButton = document.getElementById('upload-button');
        uploadButton.style.display = 'block'; // Show the upload button
    }

    // Handle image upload and extract text using Tesseract.js
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('image-display').src = e.target.result;
                //document.getElementById('image-preview').classList.add('hidden');
                recognizeTextFromImage(e.target.result); // Call function to recognize text
            };
            reader.readAsDataURL(file);
        }
    }

    // Function to recognize text from the image
// Function to recognize text from the image
function recognizeTextFromImage(imageData) {
    const wordLimit = 650;
    const charLimit = 3200;
    document.getElementById('continuebtn').style.display = 'none';
    document.getElementById('loginLoader2').style.display = 'inline-block';
    document.getElementById('image-display').classList.add('hidden');

    Tesseract.recognize(
        imageData,
        'eng',
        {
            logger: info => console.log(info) // Log progress
        }
    ).then(({ data: { text } }) => {
        console.log('Recognized text:', text); // Print recognized text to console
        document.getElementById('loginLoader2').style.display = 'none';
        document.getElementById('continuebtn').style.display = 'inline-block';
        document.getElementById('image-display').classList.remove('hidden');
        // Check and limit the text to 650 words
        let words = text.split(/\s+/);
        let truncatedText = words.length > wordLimit ? words.slice(0, wordLimit).join(' ') : text;

        // Apply character limit if necessary
        if (truncatedText.length > charLimit) {
            truncatedText = truncatedText.slice(0, charLimit) + '...'; // Truncate to character limit
        }

        document.getElementById('manual-article').value = truncatedText; // Set the article text
    }).catch(err => {
        console.error('Error recognizing text:', err);
    });
}




    let currentStep = 1;
    let hcaptchaResponse = null;
    const wordLimit = 650;

    async function nextStep() {
    const wordLimit = 650;
    const charLimit = 3200;

    if (currentStep === 1) {
        const urlInput = document.getElementById('url').value;
        let manualArticle = document.getElementById('manual-article').value.trim();

        // Check if there's an article from URL or manual entry
        if (urlInput || manualArticle) {
            // If manual entry is provided, check word and character limits
            if (manualArticle) {
                let words = manualArticle.split(/\s+/).filter(word => word.length > 0);
                
                // Apply word limit
                if (words.length > wordLimit) {
                    manualArticle = words.slice(0, wordLimit).join(' ');
                    alert('Please limit your manual article entry to 650 words.');
                }

                // Apply character limit
                if (manualArticle.length > charLimit) {
                    manualArticle = manualArticle.slice(0, charLimit);
                    alert('Character limit of 3200 characters reached.');
                }

                // Update the text area with the truncated content
                document.getElementById('manual-article').value = manualArticle;
            }

            if (urlInput) {
                await fetchArticle();  // Fetch article immediately if URL is provided
            }
            transitionToStep(2);
        } else {
            alert('Please provide an article either by URL or manual entry before continuing.');
        }
    }
}



    function validateCaptcha() {
        if (hcaptchaResponse) {
            transitionToStep(3);
        } else {
            alert('Please complete the captcha.');
        }
    }

    async function startAnalysis() {
        // Check if CAPTCHA is completed
        if (!hcaptchaResponse) {
            alert('Please complete the CAPTCHA before proceeding.');
            return; // Exit the function if CAPTCHA is not completed
        }
        document.getElementById('step-3').classList.add('fade-out');
        document.getElementById('step-counter').textContent = '4/4';
        analyzeArticle();
    }
    async function checkLogin2(){
        try {
        const user = await account.get();
        return user.email; // User is logged in
         } catch (error) {
             alert('Error 124')
            return false; // User is not logged in
         }
    }

    function transitionToStep(step) {
        document.getElementById('step-' + currentStep).classList.add('fade-out');
        setTimeout(() => {
            document.getElementById('step-' + currentStep).classList.add('hidden');
            currentStep = step;
            document.getElementById('step-' + currentStep).classList.remove('hidden');
            document.getElementById('step-' + currentStep).classList.add('fade-in');
            document.getElementById('step-counter').textContent = currentStep + '/4';
        }, 500);
    }
    function toggleManualEntry() {
        const urlInput = document.getElementById('url');
        const manualArticle = document.getElementById('manual-article');
        const enterManuallyText = document.querySelector('.manual-entry');

        if (manualArticle.classList.contains('hidden')) {
            manualArticle.classList.remove('hidden');
            urlInput.classList.add('hidden');
            enterManuallyText.textContent = "Enter URL";
        } else {
            manualArticle.classList.add('hidden');
            urlInput.classList.remove('hidden');
            enterManuallyText.textContent = "Enter Manually";
        }
    }

    function hcaptchaCallback(response) {
        hcaptchaResponse = response;
    }

    function checkWordLimit() {
    const textarea = document.getElementById('manual-article');
    const charLimit = 3200;

    // Split content into words
    let words = textarea.value.split(/\s+/);

    // Apply word limit
    if (words.length > wordLimit) {
        words = words.slice(0, wordLimit);
        textarea.value = words.join(' ');
        alert('Word limit of 650 words reached.');
    }

    // Apply character limit
    if (textarea.value.length > charLimit) {
        textarea.value = textarea.value.slice(0, charLimit);
        alert('Character limit of 3200 characters reached.');
    }
}

    async function fetchArticle() {
    document.getElementById('manual-article').value = "";
    const url = document.getElementById('url').value;
    const qrCodeCanvas = document.getElementById('qr-code');
    try {
        const response = await fetch('https://www.seektruth.co.za/api/fetch-article', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ url: url }),
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('manual-article').value = data.article;

            // Generate QR Code
            const qr = new QRious({
                element: qrCodeCanvas,
                value: url,
                size: 150,
                backgroundAlpha: 0,
                foreground: '#FFFFFF'
            });

        } else {
            alert('Failed to fetch article.');
            window.location.reload();
        }
    } catch (error) {
        console.error('Error fetching article:', error);
        alert('Error fetching article.');
        window.location.reload();
    }
}


let articleSlug;
    async function analyzeArticle() {
        const userEmail = await checkLogin2();
        if (!userEmail) {
            alert('Please log in to proceed.');
            return; // Exit the function if not logged in
        }
        const articleText = document.getElementById('manual-article').value;
        const urlInput = document.getElementById('url').value;
        const response = await fetch('https://www.seektruth.co.za/api/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                checkthis: userEmail,
                emailHash: he,
                article: articleText, 
                'h-captcha-response': hcaptchaResponse,
                urlInput : urlInput
            }),
        });

        const resultElem = document.getElementById('result');
        const circleElem = document.getElementById('circle');
        const percentageElem = document.getElementById('percentage');
        const biasLabelElem = document.getElementById('bias-label');
        const politicalLeaningElem = document.getElementById('political-leaning');
        const biasReasoningElem = document.getElementById('bias-reasoning');
        const biascom = document.getElementById('bias-com');
        const urlElem = document.getElementById('article-url');
        const communityRatingSection = document.getElementById('community-rating-section');

        if (response.ok) {
            document.getElementById('analyzebtn').style.display = 'none';
            const data = await response.json();
            const biasScore = parseInt(data.bias);
            const politicalLeaning = data.politicalLeaning;
            const biasReasoning = data.biasReasoning;
            articleSlug = data.slug; 
            resultElem.style.visibility = 'visible';
            urlElem.innerText = `Check it out`;
            urlElem.href = `https://seektruth.co.za/scanned/${data.slug}`;
            resultElem.style.visibility = 'visible';
            circleElem.style.animation = 'spin 2s linear infinite';

            setTimeout(() => {
                circleElem.style.animation = '';
                circleElem.classList.add('complete');

                if (biasScore > 60) {
                    circleElem.style.borderTopColor = 'red';
                    biasLabelElem.innerText = 'Bias';
                } else if (biasScore < 30) {
                    circleElem.style.borderTopColor = 'green';
                    biasLabelElem.innerText = 'Non-bias';
                } else {
                    circleElem.style.borderTopColor = 'yellow';
                    biasLabelElem.innerText = 'Bias Possibility';
                }

                percentageElem.innerText = biasScore + '%';
                if (politicalLeaning === "ANC") {
                politicalLeaningElem.style.color = "red";
                } else if (politicalLeaning === "DA") {
                politicalLeaningElem.style.color = "blue";
                } else if (politicalLeaning === "EFF") {
                politicalLeaningElem.style.color = "#E03C31"; 
                } else {
                politicalLeaningElem.style.color = ""; 
                }
                politicalLeaningElem.innerText = "Political Leaning: " + (politicalLeaning || "Neutral");
                biasReasoningElem.innerText = (biasReasoning || "No specific bias reasoning found.");
                const combinedBiasScore = data.communityBias;
                biascom.innerText = "Community Rating: " + combinedBiasScore + '%';
            }, 2000);
        } else {
    const errorData = await response.json(); // Capture error details
    console.error('Error:', errorData);
    // Check if the error message is empty
    if (errorData.message === "No analyses left for today") {
        // Show the no analysis points message
        const messageElement = document.getElementById('no-analysis-message');
        messageElement.classList.remove('hidden'); // Remove hidden class to display the message
    } else {
        const messageElement = document.getElementById('no-analysis-message');
        messageElement.classList.remove('hidden'); // Remove hidden class to display the message
    }
        }
    }

    function shareToTwitter() {
        const percentage = document.getElementById('percentage').innerText;
        const biasLabel = document.getElementById('bias-label').innerText;
        const url = document.getElementById('url').value;
        const text = `Bias Analysis Result: ${percentage} - ${biasLabel} | Check it out at SeekTruth.co.za #BiasDetection ${url}`;
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        window.open(twitterUrl, '_blank');
    }

    function downloadImage() {
        const result = document.getElementById('result');
        html2canvas(result).then((canvas) => {
            const link = document.createElement('a');
            link.download = 'bias_result.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
    document.getElementById("bias-com").addEventListener("click", function() {
        var container = document.getElementById("community-rating-container");
        container.style.display = container.style.display === "none" ? "block" : "none";
    });

    function updateTooltip(value) {
        var tooltip = document.getElementById("tooltip");
        var rangeInput = document.getElementById("community-rating");
        
        // Update the tooltip text
        tooltip.innerHTML = value + "%";
        
        // Position the tooltip above the thumb
        var rangeWidth = rangeInput.offsetWidth;
        var thumbPosition = (value / rangeInput.max) * rangeWidth;
        tooltip.style.left = thumbPosition + "px";
    }
    async function submitCommunityRating() {
        const communityRating = document.getElementById('community-rating').value;
        const emailHash = he;

        if (!articleSlug) {
            alert("Article slug is missing. Please analyze an article first.");
            return;
        }

        const response = await fetch('https://www.seektruth.co.za/api/rate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
           },
            body: JSON.stringify({ 
                emailHash: emailHash,
                slug: articleSlug, // Use the globally stored slug
                communityRating: communityRating
           }),
         });

        if (response.ok) {
            alert("Thank you for your rating!");
        } else {
           const errorData = await response.json(); // Capture error details
           console.error('Error:', errorData);
          alert("Error submitting your rating: " + errorData.message);
        }
        
}
//free trial modal
function showModal2() {
            document.getElementById('freeTrialModal').classList.add('show');
        }
        const closeModal = document.getElementById('closeModal2');

        
</script>

</body>
</html>